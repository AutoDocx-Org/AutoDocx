name: Build, publish and deploy to MonsterASP.NET
on:
  push:
    branches: [main]

jobs:
  build_and_deploy:
    runs-on: windows-latest
    env:
      FTP_HOST: ${{ secrets.FTP_HOST }}
      FTP_USER: ${{ secrets.FTP_USER }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_SERVER_DIR: ${{ secrets.FTP_SERVER_DIR }}
    steps:
      - uses: actions/checkout@v4

      - name: Install .NET 8 (resilient)
        shell: pwsh
        run: |
          $max = 3
          $installDir = Join-Path $env:RUNNER_TEMP 'dotnet'
          $scriptUrl = 'https://dot.net/v1/dotnet-install.ps1'
          $installed = $false
          for ($i = 1; $i -le $max; $i++) {
            try {
              Write-Host "Installing .NET (attempt $i/$max)..."
              if (Test-Path 'dotnet-install.ps1') { Remove-Item 'dotnet-install.ps1' -Force -ErrorAction SilentlyContinue }
              Invoke-WebRequest -Uri $scriptUrl -OutFile 'dotnet-install.ps1' -UseBasicParsing -ErrorAction Stop
              & .\dotnet-install.ps1 -Channel 8.0 -InstallDir $installDir -NoPath -ErrorAction Stop

              # Make it available to subsequent steps
              Add-Content -Path $env:GITHUB_PATH -Value $installDir
              Add-Content -Path $env:GITHUB_ENV -Value "DOTNET_ROOT=$installDir"

              Write-Host 'Verifying dotnet...'
              & (Join-Path $installDir 'dotnet.exe') --info
              $installed = $true
              break
            } catch {
              Write-Host "Attempt $i failed: $_"
              if ($i -lt $max) { Start-Sleep -Seconds (5 * $i) }
            }
          }
          if (-not $installed) { throw 'Failed to install .NET after retries' }
      - name: Install dependencies
        working-directory: ./backend
        run: dotnet restore

      - name: Build
        working-directory: ./backend
        run: dotnet build AutoDocx.sln --configuration Release --no-restore

      - name: Publish
        working-directory: ./backend
        run: dotnet publish AutoDocx.sln --configuration Release --output ./publish --runtime win-x86 

      - name: Smoke run API
        working-directory: ./backend
        shell: bash
        run: |
          dotnet run --project ./AutoDocx.API/AutoDocx.API.csproj --configuration Release --urls "http://localhost:5005" &
          pid=$!
          for i in $(seq 1 15); do
            if curl -sS http://localhost:5005/ >/dev/null; then
              echo "API responded"
              break
            fi
            sleep 1
          done
          kill $pid || true

      - name: FTPS Deploy
        uses: SamKirkland/FTP-Deploy-Action@4.3.1
        with:
          server: ${{ env.FTP_HOST }}
          username: ${{ env.FTP_USER }}
          password: ${{ env.FTP_PASSWORD }}
          protocol: ftps
          timeout: 60000
          security: loose
          local-dir: ./backend/publish/
          server-dir: /Site1/


